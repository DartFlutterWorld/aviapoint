#!/bin/bash

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –í–ù–ò–ú–ê–ù–ò–ï: –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ aviapoint_server, –∞ –Ω–µ –∑–¥–µ—Å—å!
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ

SERVER="root@83.166.246.205"
SERVER_PATH="/home/aviapoint_server"
LOCAL_MIGRATIONS="./migrations"

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ aviapoint_server!"
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ."
echo ""

if [ ! -d "$LOCAL_MIGRATIONS" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ migrations –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if ! ssh -o ConnectTimeout=5 $SERVER "echo 'OK'" 2>/dev/null; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
fi

# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É migrations –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
ssh $SERVER "mkdir -p $SERVER_PATH/migrations"

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ SQL —Ñ–∞–π–ª—ã
echo "üìÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π..."
scp $LOCAL_MIGRATIONS/*.sql $SERVER:$SERVER_PATH/migrations/

echo ""
echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo ""
echo "üìã –°–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
ssh $SERVER "ls -la $SERVER_PATH/migrations/"
echo ""
echo "üí° –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–µ–Ω–¥, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:"
echo "   ssh $SERVER 'cd $SERVER_PATH && docker-compose -f docker-compose.prod.yaml restart <backend_service>'"
